---
layout:     post   				    # 使用的布局（不需要改）
title:      PLSM 				# 标题 
subtitle:   PLSM, Extension of PLSA, EM #副标题
date:       2019-04-17 				# 时间
author:     WYX 						# 作者
header-img: img/3.4.png 	#这篇文章标题背景图片
catalog: true 						# 是否归档
tags:								#标签
    - PGM,PLSM,EM
---

# PLSM

This blog is to analyze the paper"A Sequential Topic Model for Mining Recurrent
Activities from Video and Audio Data Logs". Please check the reference for more information. The main goal is to derive the results.

---



Observed data:



$$
X = (w,ta,d)
$$



Complete data:



$$
(X,Z) = (w,ta,d,z,ts)
$$



生成过程文字描述如下

![](https://ww1.sinaimg.cn/large/007i4MEmgy1g26okbawdfj31n80rmk56.jpg)

其概率图为

![](https://0d077ef9e74d8.cdn.sohucs.com/rnXSRfI_png)



Based on the graphical model, it can be expressed as:


$$
p(w,ta,d,z,ts) = \sum_z \sum_{ts}p(w,d,ta,d,z,ts) \\
\space\\
=\sum_z \sum_{ts}p(d)p(z,ts|d)p(w,tr|z) \\
\space\\
= \sum_z \sum_{ts}p(d)p(z|d)p(ts|z,d)p(w,ta-ts|z) \tag{1}
$$


the likelihood function of the corpus can be represented as:


$$
L(W,Ta,D|\theta) = \prod_{w=1}^{N_d}\prod_{ta=1}^{N_{Ta}}\prod_{d=1}^{N_d}P(w,ta,d)^{n(w,ta,d)} \tag{2}
$$


Take the log likelihood function:


$$
{\cal L(W,Ta,D|\theta)} = log L(W,Ta,D|\theta)\\
\space\\
 = n(w,ta,d)log\prod_{i=1}^{N_d}\prod_{j=1}^{N_{Ta}}\prod_{k=1}^{N_d}P(w_i,ta_j,d_k) \\
 \space\\
 =n(w,ta,d)\sum_{i=1}^{N_d}\sum_{j=1}^{N_{Ta}}\sum_{k=1}^{N_d} logP(w_i,ta_j,d_k) \\
 \space\\
 Take\space (1) \space into\space the\space formula \\
 \space\\
 =\sum_{i=1}^{N_d}\sum_{j=1}^{N_{Ta}}\sum_{k=1}^{N_d}n(w,ta,d) \underbrace{log\sum_z^{N_z} \sum_{ts}^{N_{ts}}p(d)p(z|d)p(ts|z,d)p(w,ta-ts|z)}_{hard \space to\space solve} \tag{3}
$$



## Introduce KL Divergence

The formula of KL divergence is:


$$
\mathrm{KL}(\mathrm{f}(\mathrm{x}) \| \mathrm{g}(\mathrm{x}))=\sum_{x \in X} f(x) * \log _{2} \frac{f(x)}{g(x)}
$$


In the paper, the real distribution is considered as the uniform distribution$U(0,Ts)$ whose probability density function is as follows:



$$
p(x) = \frac{1}{Ts-0} =  \frac{1}{Ts}
$$



By maximizing the gap between the wanted distribution and the uniform distribution at M-step, the sparse solution is encouraged. 



(3) now can be expressed as follows by adding the KL divergence:



$$
{\cal L(W,Ta,D|\theta)} =\sum_{i=1}^{N_d}\sum_{j=1}^{N_{Ta}}\sum_{k=1}^{N_d} n(w,ta,d)\underbrace{log\sum_z^{N_z} \sum_{ts}^{N_{ts}}p(d)p(z|d)p(ts|z,d)p(w,ta-ts|z)}_{hard \space to\space solve} \\-\sum_{t_{s}, z, d} \frac{\lambda_{z, d}}{T_{d s}} \cdot \log \left(p\left(t_{s} | z, d\right)\right) \tag{4}
$$

---

### Analysis of constant term in KL divergence

Ignore the weight parameter $\lambda_{z,d}$, the KL divergence should be



$$
\sum_{t_s,z,d} \frac{1}{T_{ds} - 0} \cdot log(\frac{\frac{1}{T_{ds} - 0}}{(p(t_s|z,d)})
$$



Because we will maximize the target function, so the constant in the KL Divergence can be ignored.


$$
\sum_{t_s,z,d} \frac{1}{T_{ds} - 0} \cdot log(\frac{\frac{1}{T_{ds} - 0}}{(p(t_s|z,d)})\\
\space \\
= \sum_{t_s,z,d} \frac{1}{T_{ds} - 0} \cdot [\underbrace {log({\frac{1}{T_{ds} - 0}})}_{constant} - log(p(t_s|z,d))]\\
$$





$$
= -\sum_{t_s,z,d} \frac{1}{T_{ds}}[log(p(t_s|z,d))]
$$

---



## EM Algo

$$
{\cal L(W,Ta,D|\theta)} =\sum_{i=1}^{N_d}\sum_{j=1}^{N_{Ta}}\sum_{k=1}^{N_d} n(w,ta,d)\underbrace{log\sum_z^{N_z} \sum_{ts}^{N_{ts}}p(d)p(z|d)p(ts|z,d)p(w,ta-ts|z)}_{hard \space to\space solve} \\-\sum_{t_{s}, z, d} \frac{\lambda_{z, d}}{T_{d s}} \cdot \log \left(p\left(t_s|z,d\right)\right) \tag{4}
$$



Because the above formula is hard to solve by directly using maximal likelihood:


$$
\frac{\partial log(f_1+f_2+f_3+...+f_n)}{\partial f_1}
$$


So apply EM algorithm to (4) by introducing the hidden variable distribution


$$
\sum_{i=1}^{N_d}\sum_{j=1}^{N_{Ta}}\sum_{k=1}^{N_d} n(w,ta,d)log\sum_z^{N_z} \sum_{ts}^{N_{ts}}p(d)p(z|d)p(ts|z,d)p(w,ta-ts|z) \\ 
\space\\
=\sum_{i=1}^{N_d}\sum_{j=1}^{N_{Ta}}\sum_{k=1}^{N_d} n(w,ta,d) \underbrace{log\sum_z^{N_z} \sum_{ts}^{N_{ts}} p(z,ts|w,ta,d)\frac{ p(d)p(z|d)p(ts|z,d)p(w,ta-ts|z)}{p(z,ts|w,ta,d)}}_{{f(\mathbb Ex)}} \geq \\
\space\\
=\sum_{i=1}^{N_d}\sum_{j=1}^{N_{Ta}}\sum_{k=1}^{N_d} n(w,ta,d) \underbrace{\sum_z^{N_z} \sum_{ts}^{N_{ts}}p(z,ts|w,ta,d) log\space[\frac{ p(d)p(z|d)p(ts|z,d)p(w,ta-ts|z)}{p(z,ts|w,ta,d)}]}_{\mathbb E[{f(x)}]} \tag{5}
$$


Split the fraction of the log:


$$
\sum_{i=1}^{N_d}\sum_{j=1}^{N_{Ta}}\sum_{k=1}^{N_d} n(w,ta,d) \sum_z^{N_z} \sum_{ts}^{N_{ts}}p(z,ts|w,ta,d) log\space[\space \underbrace{p(d)p(z|d)p(ts|z,d)p(w,ta-ts|z)}]\\ - \underbrace{\sum_{i=1}^{N_d}\sum_{j=1}^{N_{Ta}}\sum_{k=1}^{N_d} n(w,ta,d) \sum_z^{N_z} \sum_{ts}^{N_{ts}} log \space p(z,ts|w,ta,d)\space p(z,ts|w,ta,d)}_{constant}
$$


Again, because of the maximal step of EM algorithm, so ignore the constant term to simplify the formula. 



So, add the KL divergence. The Q function can be expressed as:


$$
E[{\cal L}] = \sum_{w=1}^{N_d}\sum_{ta=1}^{N_{Ta}}\sum_{d=1}^{N_d} n(w,ta,d) \sum_{z=1}^{N_z} \sum_{ts=1}^{N_{ts}}p(z,ts|w,ta,d) log\space[ p(d)p(z|d)p(ts|z,d)p(w,ta-ts|z)]\\-\sum_{t_s, z,d} \frac{\lambda_{z, d}}{T_{d s}} \cdot \log \left(p\left(t_s|z,d\right)\right)  \tag{6}
$$




### E step



The E-step is to calculate the posterior distribution of the hidden variables


$$
p(z,ts|w,ta,d) =  \frac{p(z,ts,w,ta,d)}{\sum_{z=1}^{N_{z}} \sum_{ts=1}^{T_{d s}}p(z,ts,w,ta,d)} = \frac{p(z,ts,w,ta,d)}{p(w,ta,d)}
$$



**After E-step, the posterior distribution is the constant**



### M-step



M step is to maximize the parameters with constraints



$$
\theta^{(t+1)} = arg\max_\theta \int_{Z,TS} P(Z,TS|\theta^{(t)}) logP(W,Ta,D,Z,TS|\theta) dzdts
$$



Build the Lagrange function, the original function $E[L]$ has  following constraints for each document



$$
\sum_{w=1}^{N_w} \sum_{tr=1}^{N_{tr}} p(w,tr|z) = 1 \\
\sum_{z=1}^{N_z} \sum_{ts=1}^{N_{ts}} p(z,ts|d) = 1
$$



**Note: in the solution part, this blog tries to solve (p(w,tr|z),p(z,ts|d)) and (p(w,tr|z),p(z|d),p(ts|z,d))**

**Also, the Lagrange function is also different for different hidden variables **



#### Build Lagrange function 1



For the first case, because we want the z_ts table to be sparse, so the wanted distribution is changed here:


$$
E[{\cal L}] = \sum_{w=1}^{N_d}\sum_{ta=1}^{N_{Ta}}\sum_{d=1}^{N_d} n(w,ta,d) \sum_{z=1}^{N_z} \sum_{ts=1}^{N_{ts}}p(z,ts|w,ta,d) log\space[ p(d)p(z|d)p(ts|z,d)p(w,ta-ts|z)]\\\underbrace{-\sum_{t_s, z,d} \frac{\lambda_{z, d}}{T_{ds}} \cdot \log(p(t_s|z,d))}_{change} \\
\space\\
\Rightarrow E[{\cal L}] = \sum_{w=1}^{N_d}\sum_{ta=1}^{N_{Ta}}\sum_{d=1}^{N_d} n(w,ta,d) \sum_{z=1}^{N_z} \sum_{ts=1}^{N_{ts}}p(z,ts|w,ta,d) log\space[ p(d)p(z|d)p(ts|z,d)p(w,ta-ts|z)]\\\underbrace{-\sum_{t_s, z,d} \frac{\lambda_{z, d}}{T_{ds}} \cdot \log(p(z,t_s|d))}_{joint\space distribution}
$$




**Lagrange function** can  be expressed as follows:


$$
Lag = E[\mathcal{L}] + \sum_{d=1}^{N_d}\lambda_d (1 -\sum_{w=1}^{N_w} \sum_{tr=1}^{N_{tr}} p(w,tr|z) ) +\\ \sum_{d=1}^{N_d}\mu_d(1-\sum_{z=1}^{N_z} \sum_{ts=1}^{N_{ts}} p(z,ts|d)) \tag{7}
$$

$$
= \sum_{d=1}^{N_d}\sum_{ta=1}^{N_{Ta}}\sum_{w=1}^{N_w} n(w,ta,d) \sum_z^{N_z} \sum_{ts}^{N_{ts}} p(z,ts|w,ta,d) log\space[p(d)p(z|d)p(ts|z,d)p(w,tr|z)]\\-\sum_{t_s, z,d} \frac{\lambda_{z, d}}{T_{d s}} \cdot \log \left(p\left(t_s|z,d\right)\right) 
+ \sum_{d=1}^{N_d}\lambda_d (1 -\sum_{w=1}^{N_w} \sum_{tr=1}^{N_{tr}} p(w,tr|z) )  +\\ \sum_{d=1}^{N_d}\mu_d(1-\sum_{z=1}^{N_z} \sum_{ts=1}^{N_{ts}} p(z,ts|d))
$$



Recall that


$$
ta = tr + ts \\
\space\\
Replace \space ta \space with\space the\space equation \\
\\space \\
do\space the\space same\space thing\space to\space the\space \sum_{ta}^{N_{Ta}}
$$




$$
= \sum_{d=1}^{N_d}\sum_{tr=0}^{Tz-1}\sum_{w=1}^{N_w}\sum_{z=1}^{N_z} \sum_{ts=1}^{N_{ts}} n(w,ts+tr,d)  p(z,ts|w,ts+tr,d) log\space[p(d)p(z|d)p(ts|z,d)p(w,tr|z)]\\-\sum_{t_s, z,d} \frac{\lambda_{z, d}}{T_{d s}}\log(p(z,t_s|d))  \\
+ \sum_{d=1}^{N_d}\lambda_d (1 -\sum_{w=1}^{N_w} \sum_{tr=1}^{N_{tr}} p(w,tr|z) )  +\\ \sum_{d=1}^{N_d}\mu_d(1-\sum_{z=1}^{N_z} \sum_{ts=1}^{N_{ts}} p(z,ts|d))
$$

The other three sum symbols $\sum_{tr=0}^{Tz-1}\sum_{w=1}^{N_w}\sum_{z=1}^{N_z}$can be eliminated when we focus one parameter. The KL divergence can be ignored, has no relation for current parameter





#### Solve p(w,tr|z)




$$
\frac{\partial {\cal{Lag}}}{\partial p(w,tr|z)} \Rightarrow \frac{\sum_{d=1}^{N_d}\sum_{ts=1}^{N_{ts}}n(w,ts+tr,d)  p(z,ts|w,ts+tr,d)}{p(w,tr|z)} - \sum_{d=1}^{N_d}\lambda_d = 0\\
\space\\

\Rightarrow \sum_{d=1}^{N_d}\sum_{ts=1}^{N_{ts}}n(w,ts+tr,d)p(z,ts|w,ts+tr,d) = p(w,tr|z)\sum_{d=1}^{N_d}\lambda_d\\
\space\\
Introduce \space the \space contraint\\
\space\\
\Rightarrow \sum_{w=1}^{N_w} \sum_{tr=1}^{N_{tr}}\sum_{d=1}^{N_d}\sum_{ts=1}^{N_{ts}}n(w,ts+tr,d)p(z,ts|w,ts+tr,d) = \underbrace{\sum_{w=1}^{N_w} \sum_{tr=1}^{N_{tr}}p(w,tr|z)}_1\sum_{d=1}^{N_d}\lambda_d\\
\space\\
\Rightarrow \sum_{d=1}^{N_d}\lambda_d =  \sum_{w=1}^{N_w} \sum_{tr=1}^{N_{tr}}\sum_{d=1}^{N_d}\sum_{ts=1}^{N_{ts}}n(w,ts+tr,d)p(z,ts|w,ts+tr,d) \tag{8}
$$

$$
Take \space \sum_{d=1}^{N_d}\lambda_d \space back \space in \space to \space the \space formula \\
\space \\
\Rightarrow \sum_{d=1}^{N_d}\sum_{ts=1}^{N_{ts}}n(w,ts+tr,d)p(z,ts|w,ts+tr,d) = p(w,tr|z)\sum_{d=1}^{N_d}\lambda_d\\
\space \\
\Rightarrow p(w,tr|z) = \frac{\sum_{d=1}^{N_d}\sum_{ts=1}^{N_{ts}}n(w,ts+tr,d)p(z,ts|w,ts+tr,d)}{\sum_{d=1}^{N_d}\lambda_d}\\
\space \\
\Rightarrow p(w,tr|z) = \frac{\sum_{d=1}^{N_d}\sum_{ts=1}^{N_{ts}}n(w,ts+tr,d)p(z,ts|w,ts+tr,d)}{\sum_{w=1}^{N_w} \sum_{tr=1}^{N_{tr}}\sum_{d=1}^{N_d}\sum_{ts=1}^{N_{ts}}n(w,ts+tr,d)p(z,ts|w,ts+tr,d)}
$$



the result can be expressed as:


$$
\\
\space \\
\Rightarrow p(w,tr|z) \propto \sum_{d=1}^{N_d}\sum_{ts=1}^{N_{ts}}n(w,ts+tr,d)p(z,ts|w,ts+tr,d)
$$






#### p(z,ts|d)





First recall that:


$$
p(z,ts|d) = p(z|d)p(ts|z,d)
$$




So Lagrange function can be written as:


$$
= \sum_{d=1}^{N_d}\sum_{tr=0}^{Tz-1}\sum_{w=1}^{N_w}\sum_{z=1}^{N_z} \sum_{ts=1}^{N_{ts}} n(w,ts+tr,d)  p(z,ts|w,ts+tr,d) log\space[p(d)\underbrace{p(z,ts|d)}_{p(z|d)p(ts|z,d)}p(w,tr|z)]\\-\sum_{t_s, z,d} \frac{\lambda_{z, d}}{T_{d s}}\log(p(z,t_s|d))  \\
+ \sum_{d=1}^{N_d}\lambda_d (1 -\sum_{w=1}^{N_w} \sum_{tr=1}^{N_{tr}} p(w,tr|z) )  \\+ \sum_{d=1}^{N_d}\mu_d(1-\sum_{z=1}^{N_z} \sum_{ts=1}^{N_{ts}} p(z,ts|d))
$$


p(z,ts|d) represents one parameter, so it eliminates three sums $\sum_{d=1}^{N_d}\sum_{z=1}^{N_z} \sum_{ts=1}^{N_{ts}}$



$$
\frac{\partial {\cal{Lag}}}{\partial p(z,ts|d)} \Rightarrow \frac{\sum_{tr=0}^{Tz-1}\sum_{w=1}^{N_w}n(w,ts+tr,d)  p(z,ts|w,ts+tr,d) }{\underbrace{p(z,ts|d)}} \\
\space \\
- \frac{\lambda_{z,d}}{T_{ds}\underbrace{p(z,ts|d)}} - \sum_{d=1}^{N_d}\mu_d = 0 \tag{9}
$$



$$
\Rightarrow \frac{1}{p(z,ts|d)}(\sum_{tr=0}^{Tz-1}\sum_{w=1}^{N_w} n(w,ts+tr,d)  p(z,ts|w,ts+tr,d)- \frac{\lambda_{z,d}}{ T_{ds} } ) = \sum_{d=1}^{N_d}\mu_d \\
\space\\
\Rightarrow \sum_{tr=0}^{Tz-1}\sum_{w=1}^{N_w} n(w,ts+tr,d)  p(z,ts|w,ts+tr,d)- \frac{\lambda_{z,d}}{ T_{ds} }  = p(z,ts|d)\sum_{d=1}^{N_d}\mu_d\\
\space\\
Introduce \space the \space contraint \space \sum_{z=1}^{N_z} \sum_{ts=1}^{N_{ts}} p(z,ts|d) = 1\\
\space\\
\Rightarrow \underbrace{\sum_{z=1}^{N_z} \sum_{ts=1}^{N_{ts}}} \sum_{tr=0}^{Tz-1}\sum_{w=1}^{N_w}n(w,ts+tr,d)  p(z,ts|w,ts+tr,d)- \frac{\lambda_{z,d}}{ T_{ds} }  = \sum_{z=1}^{N_z} \sum_{ts=1}^{N_{ts}} p(z,ts|d)\underbrace{\sum_{d=1}^{N_d}\mu_d}\\
\space\\
\Rightarrow \sum_{z=1}^{N_z} \sum_{ts=1}^{N_{ts}}\sum_{tr=0}^{Tz-1}\sum_{w=1}^{N_w} n(w,ts+tr,d)  p(z,ts|w,ts+tr,d)- \frac{\lambda_{z,d}}{ T_{ds} }  = \underbrace{\sum_{d=1}^{N_d}\mu_d} \underbrace{\sum_{z=1}^{N_z} \sum_{ts=1}^{N_{ts}} p(z,ts|d)}_1\\
\space\\
\Rightarrow \sum_{d=1}^{N_d}\mu_d = \sum_{z=1}^{N_z} \sum_{ts=1}^{N_{ts}}\sum_{tr=0}^{Tz-1}\sum_{w=1}^{N_w} n(w,ts+tr,d)  p(z,ts|w,ts+tr,d)- \frac{\lambda_{z,d}}{ T_{ds} }
$$


$$
Take \space  \sum_{d=1}^{N_d}\mu_d \space back \space in \space to \space the \space formula \\
\space \\
\Rightarrow \sum_{tr=0}^{Tz-1}\sum_{w=1}^{N_w} n(w,ts+tr,d)  p(z,ts|w,ts+tr,d)- \frac{\lambda_{z,d}}{ T_{ds} }  = p(z,ts|d)\sum_{d=1}^{N_d}\mu_d\\
\space\\
\Rightarrow  p(z,ts|d) = \frac{\sum_{tr=0}^{Tz-1}\sum_{w=1}^{N_w} n(w,ts+tr,d)  p(z,ts|w,ts+tr,d)- \frac{\lambda_{z,d}}{ T_{ds} }}{\sum_{d=1}^{N_d}\mu_d}\\
\space\\
\Rightarrow  p(z,ts|d) = \frac{\sum_{tr=0}^{Tz-1}\sum_{w=1}^{N_w} n(w,ts+tr,d)  p(z,ts|w,ts+tr,d)- \frac{\lambda_{z,d}}{ T_{ds} }}{\sum_{z=1}^{N_z} \sum_{ts=1}^{N_{ts}}\sum_{tr=0}^{Tz-1}\sum_{w=1}^{N_w} n(w,ts+tr,d)  p(z,ts|w,ts+tr,d)- \frac{\lambda_{z,d}}{ T_{ds} }}
$$


The result can be expressed as:


$$
p(z,ts|d) \propto \sum_{tr=0}^{Tz-1}\sum_{w=1}^{N_w} n(w,ts+tr,d)  p(z,ts|w,ts+tr,d)- \frac{\lambda_{z,d}}{T_{ds}}
$$




#### Build Lagrange function 2




$$
Lag = E[\mathcal{L}] + \sum_{d=1}^{N_d}\lambda_d (1 -\sum_{w=1}^{N_w} \sum_{tr=1}^{N_{tr}} p(w,tr|z) ) +\\ \sum_{d=1}^{N_d}\mu_d(1-\sum_{z=1}^{N_z} \sum_{ts=1}^{N_{ts}} p(z,ts|d)) \tag{10}
$$

$$
= \sum_{d=1}^{N_d}\sum_{ta=1}^{N_{Ta}}\sum_{w=1}^{N_w} n(w,ta,d) \sum_{z=1}^{N_z} \sum_{ts=1}^{N_{ts}} p(z,ts|w,ta,d) log\space[p(d)p(z|d)p(ts|z,d)p(w,tr|z)]\\-\sum_{t_s, z,d} \frac{\lambda_{z, d}}{T_{d s}} \cdot \log \left(p\left(t_s|z,d\right)\right) 
+ \sum_{d=1}^{N_d}\lambda_d (1 -\sum_{w=1}^{N_w} \sum_{tr=1}^{N_{tr}} p(w,tr|z) )  +\\ \sum_{d=1}^{N_d}\mu_d(1-\sum_{z=1}^{N_z} p(z|d)) + \sum_{d=1}^{N_d}\alpha_d(1-\sum_{z=1}^{N_z} \sum_{ts=1}^{N_{ts}} p(ts|z,d)) \tag{11}
$$




#### Solve P(z|d)




$$
\frac{\partial {\cal{Lag}}}{\partial p(z|d)} \Rightarrow \frac{\sum_{ts=1}^{N_{ts}}\sum_{tr=0}^{Tz-1}\sum_{w=1}^{N_w}n(w,ts+tr,d)  p(z,ts|w,ts+tr,d) }{p(z|d)} \\
\space \\- \sum_{d=1}^{N_d}\mu_d = 0 \\
\space\\
\Rightarrow \sum_{ts=1}^{N_{ts}}\sum_{tr=0}^{Tz-1}\sum_{w=1}^{N_w}n(w,ts+tr,d)  p(z,ts|w,ts+tr,d)  = p(z|d) \sum_{d=1}^{N_d}\mu_d
$$

$$
\\
\space\\
Introduce \space the \space contraint \space \sum_{z=1}^{N_z} p(z|d)\\
\space\\
\Rightarrow \sum_{z=1}^{N_z}\sum_{ts=1}^{N_{ts}}\sum_{tr=0}^{Tz-1}\sum_{w=1}^{N_w}n(w,ts+tr,d)  p(z,ts|w,ts+tr,d)  = [\sum_{d=1}^{N_d}\mu_d]\underbrace{\sum_{z=1}^{N_z}p(z|d) }_1 \\
\space\\
\Rightarrow \sum_{d=1}^{N_d}\mu_d = \sum_{z=1}^{N_z}\sum_{ts=1}^{N_{ts}}\sum_{tr=0}^{Tz-1}\sum_{w=1}^{N_w}n(w,ts+tr,d)  p(z,ts|w,ts+tr,d)
$$

$$
Take \space  \sum_{d=1}^{N_d}\mu_d \space back \space in \space to \space the \space formula \\
\space \\
\Rightarrow \sum_{ts=1}^{N_{ts}}\sum_{tr=0}^{Tz-1}\sum_{w=1}^{N_w}n(w,ts+tr,d)  p(z,ts|w,ts+tr,d)  = p(z|d) \sum_{d=1}^{N_d}\mu_d\\
\space\\
\Rightarrow p(z|d) = \frac{\sum_{ts=1}^{N_{ts}}\sum_{tr=0}^{Tz-1}\sum_{w=1}^{N_w}n(w,ts+tr,d)  p(z,ts|w,ts+tr,d)}{\sum_{d=1}^{N_d}\mu_d}\\
\space\\
p(z|d) = \frac{\sum_{ts=1}^{N_{ts}}\sum_{tr=0}^{Tz-1}\sum_{w=1}^{N_w}n(w,ts+tr,d)  p(z,ts|w,ts+tr,d)}{\sum_{z=1}^{N_z}\sum_{ts=1}^{N_{ts}}\sum_{tr=0}^{Tz-1}\sum_{w=1}^{N_w}n(w,ts+tr,d)  p(z,ts|w,ts+tr,d)}
$$


The result can be expressed as:


$$
p(z|d) \propto \sum_{ts=1}^{N_{ts}}\sum_{tr=0}^{Tz-1}\sum_{w=1}^{N_w}n(w,ts+tr,d)  p(z,ts|w,ts+tr,d)
$$




#### Solve P(ts|z,d)




$$
=  \sum_{d=1}^{N_d}\sum_{tr=0}^{Tz-1}\sum_{w=1}^{N_w}\sum_{z=1}^{N_z} \sum_{ts=1}^{N_{ts}} n(w,ta,d) p(z,ts|w,ta,d) log\space[p(d)p(z|d)p(ts|z,d)p(w,tr|z)]\\-\sum_{t_s, z,d} \frac{\lambda_{z, d}}{T_{d s}} \cdot \log \left(p\left(t_s|z,d\right)\right) 
+ \sum_{d=1}^{N_d}\lambda_d (1 -\sum_{w=1}^{N_w} \sum_{tr=1}^{N_{tr}} p(w,tr|z) )  +\\ \sum_{d=1}^{N_d}\mu_d(1-\sum_{z=1}^{N_z} p(z|d)) + \sum_{d=1}^{N_d}\alpha_d(1-\sum_{z=1}^{N_z} \sum_{ts=1}^{N_{ts}} p(ts|z,d)) \tag{11}
$$





$$
\frac{\partial {\cal{Lag}}}{\partial p(ts|z,d)} \Rightarrow \frac{\sum_{tr=0}^{Tz-1}\sum_{w=1}^{N_w}n(w,ts+tr,d)  p(z,ts|w,ts+tr,d) }{p(ts|z,d)} \\
\space \\- \frac{\lambda_{z,d}}{T_{ds}\space p(ts|z,d)} - \sum_{d=1}^{N_d}\alpha_d = 0 \\
\space\\
\Rightarrow \sum_{tr=0}^{Tz-1}\sum_{w=1}^{N_w}n(w,ts+tr,d) n(w,ts+tr,d)  p(z,ts|w,ts+tr,d)- \frac{\lambda_{z,d}}{T_{ds}}  = p(ts|z,d) \sum_{d=1}^{N_d}\alpha_d\\
\space\\
Introduce \space the \space contraint \space \sum_{z=1}^{N_z} \sum_{ts=1}^{N_{ts}} p(ts|z,d)\\
\space\\
\Rightarrow \sum_{z=1}^{N_z} \sum_{ts=1}^{N_{ts}}  \sum_{tr=0}^{Tz-1}\sum_{w=1}^{N_w}n(w,ts+tr,d) n(w,ts+tr,d)  p(z,ts|w,ts+tr,d)- \frac{\lambda_{z,d}}{T_{ds}} =\underbrace{\sum_{z=1}^{N_z} \sum_{ts=1}^{N_{ts}} p(ts|z,d)}_1\sum_{d=1}^{N_d}\alpha_d\\
\space\\
\Rightarrow \sum_{d=1}^{N_d}\alpha_d = \sum_{z=1}^{N_z} \sum_{ts=1}^{N_{ts}}  \sum_{tr=0}^{Tz-1}\sum_{w=1}^{N_w}n(w,ts+tr,d) n(w,ts+tr,d)  p(z,ts|w,ts+tr,d)- \frac{\lambda_{z,d}}{T_{ds}}
$$



$$
Take \space  \sum_{d=1}^{N_d}\alpha_d \space back \space in \space to \space the \space formula \\
\space \\
\Rightarrow \sum_{tr=0}^{Tz-1}\sum_{w=1}^{N_w}n(w,ts+tr,d) n(w,ts+tr,d)  p(z,ts|w,ts+tr,d)- \frac{\lambda_{z,d}}{T_{ds}}  = p(ts|z,d) \sum_{d=1}^{N_d}\alpha_d\\
\space\\
p(ts|z,d) = \frac{\sum_{tr=0}^{Tz-1}\sum_{w=1}^{N_w}n(w,ts+tr,d) n(w,ts+tr,d)  p(z,ts|w,ts+tr,d)- \frac{\lambda_{z,d}}{T_{ds}}}{\sum_{d=1}^{N_d}\alpha_d}\\
\space\\
p(ts|z,d) = \frac{\sum_{tr=0}^{Tz-1}\sum_{w=1}^{N_w}n(w,ts+tr,d) n(w,ts+tr,d)  p(z,ts|w,ts+tr,d)- \frac{\lambda_{z,d}}{T_{ds}}}{\sum_{z=1}^{N_z} \sum_{ts=1}^{N_{ts}}  \sum_{tr=0}^{Tz-1}\sum_{w=1}^{N_w}n(w,ts+tr,d) n(w,ts+tr,d)  p(z,ts|w,ts+tr,d)- \frac{\lambda_{z,d}}{T_{ds}}}
$$



The result can be expressed as:


$$
p(ts|z,d) \propto \sum_{tr=0}^{Tz-1}\sum_{w=1}^{N_w}n(w,ts+tr,d) n(w,ts+tr,d)  p(z,ts|w,ts+tr,d)- \frac{\lambda_{z,d}}{T_{ds}}
$$
